#!/bin/bash

set -meuo pipefail

# Anvil Private Key
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

# Contract Addresses
MOCK_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
VERIFIER_ADDRESS=0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512

# Guardian Set
APPEND_SET_FUNCTION_SIG="appendGuardianSet((address[], uint32))"
EXPIRATION_TIME=$(date -d "1 year" +%s)

GUARDIAN_ADDRESSES=(
  "0x1bB315E24af6Bb5DaBA538dD17A6168CFA91A213"
  "0xd1FfC4DD68bD8F241032b5BeaC1Cf6099c5c8011"
  "0x7Ab4F18499e49fF14B1B1EAaD92c0229036AD052"
  "0x4ac1bDFCDc3Ef49A9553d1BCf6a56e36E815eA06"
  "0xD1523F8e5dC2ecf403Dc733819CB20185F8D6Ad1"
  "0xb7d8612e65d6f95707173492bb497728108B6b9a"
  "0x3022Ee66b0fD56D6a3F0B5b520973b29c2Ef67ea"
  "0x8b0798246b538f49EaF429B5b011eb65c5A30CDe"
  "0x9b550E6cb0553dEE579ecf2700D096BB235783F1"
  "0x7BA7f6ACFcD9a721eB906A2Da8Ebcbc8a83F250B"
  "0x6ebDa46121D17b95220F2f9af86c68CE90b79085"
  "0x4Fdd5551d20f0D3798fD9Da624Ae8FCC6959EDB2"
  "0x1d7C41eCc9D30f84a922708C9aEA53C3F5DBcB65"
  "0x3e1fD6000B547F1D8302D6eeB89aadeEA5F6dE3d"
  "0x4Ae924b2b7F4992b11285DAFE052D158Dfd80d06"
  "0x7d4B0dEDB4E8D43801823632e788cd600e45292C"
  "0x2F38a48F8968114aA5a62E3A106d2D3DD5478bF2"
  "0x2F53c488E589c1e023ccE9f21f1379213A7C30fa"
  "0xE38C099F0732eca09881F99E7431A619d3D033d9"
)

IFS=,
GUARDIAN_SET="([${GUARDIAN_ADDRESSES[*]}], $EXPIRATION_TIME)"

# Verifier Update
UPDATE_FUNCTION_SIG="update(bytes)"
PULL_AND_APPEND_MESSAGE=0x0200000001010cac01000000001300c0f3e20c096806758ea3b0b5a3acd035729db8d8e7e8992f7a85d29301c92ce76a1406d372501e7c704178139f51188d53d88433a6c7455a0bdc28011bd4ed840001c4089a495c3c5ba2537b9ec874815e9f8eafe3c550cad1d3cf8c11d88ebb8d7848e83dfaed411cc6ba7bcd799c3a4b0c8ad6fd719f9a00148e40af9ff200d49e01025b530f885591e9f109bfdf1efc74b3cdbbabd9faa9c716f83ad6dfb8365d8c5b0048b392b2f37e214495763a8df98eccb2efe5747078c8d77f194a72037c25b401036c4b4192eb61bf9939836b5464bb761146a05a56a3b55003542ffe505ae1892f44a47ca8d7e516641dc09445a7f923837e56d9276e967e80133bb41e15f9ba9700047ab2115d80337de771dcc173726634cdea3a93585a83b0a85c2cca816a6b8a9d1281b663d0a760fb3a85bcedcc4fba4239ce46e67e2332ee093d4047afcacff100055033816adc51521414831c8d59e958ed87261823473a0a6275d490507aeca66c3c1dcd901a564de664b0b57ee92f3548b263fdf658c1bc91063e47f73adf081101069d7b7b1269f3d27c6267409d7b3e454a71c50f6c8152ae10c7eb88919ee8c211595bb76c27d2cd07fdccbd669ad0d6256ec973bd3f3b32ee46fd12fc658b9b7b0107a42e087e5d104c31b5a58715fcf77a855c99252aca7300ee8eda368a864c4ec564062d204aa618b8494416302a6f6956be0af3e9122fe327fff6a7daa95d33550108ae5235fab6927400bb5722269e3d3e1beda6738be563c2ea83ad83650adbd0190a0ff52e6963b68cdc2e955230e7bc0985fcae99d730d00fd00cd9065744c59f0109bd15e2cbb22e860f730946f60ddc4de4c73add8dc1ecbec2e48df7591922520b1efe14060a5fd4c1d9fcd8bd291a415100f730d587ac679e5004577d966caa5f010a6cdb20c9ba1af20589b744b524a1c79fb767552e974445a5bcc10ef449254fae7fcc72ccf9a6eb835ef94c81afb8fbe46ba344f51bc0f5119d5d84137d773501000b1a797d0e3bc0215d7505451329e3dd40cd0452481ec4133b616dc08d266ef73260fa875880eedd028e5c4e736825aa05abe93233d95a5fd95c0055a954289e92000c71bd03bd0c38f8bee05df2ef222baa41661f7f7111f25a4d03f3a74358c92155508f2f16986b3a8eef780991f26def7ceebbd1d7845559622c599ee4be035673000d24fbdea259d28c49ce44f4b54be6e6a4bf7bae92c76c77f95044404881c55be33908bdc6e0dfd9ee7519c7e7488f78390c394c6faeda7a7ecbbc1061a8fb305a010ee51261852fedd24659d439d498062c97fde9887fcd47b244b55d1c628f489cd044096a15c137ee27a402575ae6965f68e8623eedfe4a7362b40524d4c84343eb010f8518079d35947dc3ea8eea710098b8761451bded501326fe754eb9c735af877e33484924d648648edd64a791bad6260b20091f293310a32b0b3a3d89f9cf3fde01102a41287e63a8369c47371fca1097d27c84344ccbe59696919c5a62c026284a8b3a7dc488ee9238cdbb9a3d64821834a2c47e026c04c26cfae12232aeddecf22f011172a5a9ceca825184e67f68063b1dacf7893a591d272f1d83830b17a324a9e99438a593f997a231b94a0e53ea08e1255091a2ea77e0835413893ff266dfad0cae001251927245c0bd63a12885d60b1dd85621617f3f1eac6abbadabb6e3d3eeab2299224caa650dcfd69a8ab15da209af87b4044a92c33340fc71bdf886470c957141010000000000000000000100000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000545353010000000000000000c11b6c8b8e4ecc62ebf10437678eb70f17f1e53abdb3fa8df1912e3b3d11b5b90000000079831ad0cf743c19f5dc5d7c428f50eb0d7ac2a5f1eaf64ce57ae99492cbf03d6a18d84ddd59f198dde97ed75bb518b7d5167d6ad7ccfac44f89751dd1cb895f14e36f643d776734957d87a5fbd75c000250273712533f983c43b56f8ba88a703e5ba37554586738f317486d9069e782f9b2a29e47aced55267fbff6aee20b5238e06ce0a00edb51853210e0ee416679926fbb8fd0db5835454e9a59a58ea4d01e5c9b1c1746bef479298b549a69e8f884857300cc84284f0f616692e73af5bbb2f99a594f7064265d259f94a6c05f81c91e330cd2e21fe79b353b737489191b59d07c47474868a06ce879a0cbe346d055b38d9c94b34d575327713c80ddc8e19592af6b66eb3a44fe7eabe39bed6ecf002440e4f9abaa10878dbfc0d6fc5be9987961d972d6c9662b152c32a5d54606aea4d03cd55d7d81b823db340eb5f699e5a49f8a5e6349f4d1cc6fc95d47d2c98fa748f453e1c8acdc2dbeacbad2e4fa26aa40f3b03a8bea902e88ff3cee8d4f82ae2c9552c400d0ab94c1248c616b6d5ef1e9010ae029fa0d4823a6a1402738fd019460d908ac7c916359bbdf08b4e68208e5d14e5d40699bd646634264cf1204d6f63af2845b2e3ee50ec9c1bbcd0be95660ae6fdc0014d96a8f50365365ab4af28a8da7417ada01d438e54affb263f501ae306a76d1bd03793e7edc22b02cf42a1100a82a9d0bfe2b7c7a80ee7edda0109ba5be199d092bdf3213a4e0851fdcc094ce0b680558c407d9b80b606f5828bba88684e4809ed80733ff740c4a733702f313c147685c48ed4f2adcdc4751e8d80e6f9925185c3b0375884354429948d07d6381361d9427d630b019ed3a35ac730ec6c63136e7aafb35108514ea63e25e46d1e5bb65c449ffb5e483eff8ca5f32f2691c25d1007d5db8ee05ce72b73cf9cdb233e031174b15a60ba2c2a513774718976df35581a3f54085a40cf21ddacb42244d6f6ea20a65cf49daacc04eed40fb2b3c94a770fbce3ba0cea4ddc0661d917a1ce8b9db845c98a8403bec4a6b4dc2d25a0b078138979f4e807be653a0f58ff5546ba8304dc155ec0e22834b15ab17fc22bc4a782ce19b084b95716173661fb19e8e695ceedd4c883a460397bb30144e88788f6054a6300e4a0617585549c8a0daba98da55497b1a4d63faef471c5b6412de3ac0442a0032c8a54db6c557f22a1c780b71cd6353161a44054957e87b557a69fd950e6310edb269001e1c96f20c8b63ef35100767a1b864c03b7b7db0522c860dc4adec6cb444e5bee0acec9a7937706847d146eb42513d5db2a8f40c1727ac11e774dcfa938cb35b1daa494808567a9b67a659acbd1eef934291fb67640dfd09f670135b6b4ff70fb65f7d03e3385af64b2b51b4e9e1da419f7d0037abdcb126bdf3c4e4a5b8ab8d3ee72a8d720ae6a4bd653b2e45bb39ef1b44302bc68391c46dc9484f8dddde0b77a84ed8805028cf4a210a7726798397c4117770e22d1e5876d07494b00bbda5b5f216e9118136b9d61ec40f767bca16b6bc5e787e4ea199171ccffce724d84783937b25ad5718a08c8fb6c91890cb9ed46a14e37f9b327051752b66b068e1caedabe88ad2225f2b8e85df873fcb59d00dfe4a563ee95c30ba2486c3e539b0e31c30db6ba66851ea8620331f58f1946094c9c2e7b6a2b164c412ab38c44d8d3359e74e523acde98231f5c4d455d32617b3888b2cb1cbb930f1bb99e4feb3b40b32a82ac307625d375a34bb198cc8fc574df1c24e53eb78c031e8db560849c1804b3922ea63c469bd861961a6d40b021b4eee2ac335dbe70daa6f2e0f044b4abe4ed0e9b657ce80bd032cd69c90c4caeb014f56f3641587d242423a2acfd7905e320f44fd7f8043c6d0490d84ac7ede67de92f3032dc5df526ccf27a04872a2e022add8e1a734eb31588a327f446957ea6b0af7ef38a5fd36f91763adfa2f1947b220af7f9a93a466b89446e023109d36b9234ac0c791e0f89b75933b31c6ac1f590e84aca13414b6e3c9ede89cd56f2eb9d470115a5da0daeafca900c6b5d8754df7bbc5341b6c3655e2a8975c70bad54aec506f3542e379f6ae26e23413076aeb6103ea46c37d26315fd64b9651f93badd46f8d313898a7406114bbc9b3a4325361181e8508672dd9ba1493d9261e864bc48f9eae2c50a73cd2963b83ac48f60c1942d06371b6a89511eb69c3c7f030fe4e306511e307cefcac9d3715c68ef19a87ee57ca74b8f7e17029f4edc0174bc083f0da6440dda5c801c129745e8fe243812c4b7020bb5780a104d473d6b1e89fea8dcbb601cb992c111fcc1ff4b44f894f9d0293b8482dd5a21fd08de95bd99ace512158bd4ad8890f0bbae3920dae6cf3a20662d92fe6ff249de6a6855000b41b8c4edab3f4dd933c1b139b421db64785371f264744d456686c2b33eb60eb3cab7feaf52cf9147d48b61629b3a49e2246208857596e8d60ae23c816af20be8c45dfc0c5446423d97b7850046b0e79ea971ce547ce717cc7ba9bbfdb9ebb9cc5eb542a006f2c39db4f2e84f4451b2a35e43b5fd87baa0e4c98a1b45402d9ea7bbe46a34d17cb8d7a6d6a400393033d5ccbab836f5b83fcf6ccf81e9215276307

anvil --quiet --host 0.0.0.0 &

deadline=$((SECONDS+60))
until cast block-number >/dev/null 2>&1; do
    if [ "$SECONDS" -ge "$deadline" ]; then
        echo "Timed out waiting for anvil" >&2
        exit 1
    fi
    sleep 0.5
done

forge create --private-key $PRIVATE_KEY --broadcast test/WormholeVerifier.t.sol:WormholeV1Mock
forge create WormholeVerifier --private-key $PRIVATE_KEY --broadcast --constructor-args $MOCK_ADDRESS 0 0 0 0x
cast send --private-key $PRIVATE_KEY $MOCK_ADDRESS "$APPEND_SET_FUNCTION_SIG" "$GUARDIAN_SET"
cast send --private-key $PRIVATE_KEY $VERIFIER_ADDRESS "$UPDATE_FUNCTION_SIG" "$PULL_AND_APPEND_MESSAGE"
fg
