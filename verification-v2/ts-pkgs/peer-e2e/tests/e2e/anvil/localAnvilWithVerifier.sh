#!/bin/bash

set -meuo pipefail

# Anvil Private Key
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

# Contract Addresses
MOCK_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
VERIFIER_ADDRESS=0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512

# Guardian Set
APPEND_SET_FUNCTION_SIG="appendGuardianSet((address[], uint32))"
EXPIRATION_TIME=$(date -d "1 year" +%s)

GUARDIAN_ADDRESSES=(
  "0x1bB315E24af6Bb5DaBA538dD17A6168CFA91A213"
  "0xd1FfC4DD68bD8F241032b5BeaC1Cf6099c5c8011"
  "0x7Ab4F18499e49fF14B1B1EAaD92c0229036AD052"
  "0x4ac1bDFCDc3Ef49A9553d1BCf6a56e36E815eA06"
  "0xD1523F8e5dC2ecf403Dc733819CB20185F8D6Ad1"
  "0xb7d8612e65d6f95707173492bb497728108B6b9a"
  "0x3022Ee66b0fD56D6a3F0B5b520973b29c2Ef67ea"
  "0x8b0798246b538f49EaF429B5b011eb65c5A30CDe"
  "0x9b550E6cb0553dEE579ecf2700D096BB235783F1"
  "0x7BA7f6ACFcD9a721eB906A2Da8Ebcbc8a83F250B"
  "0x6ebDa46121D17b95220F2f9af86c68CE90b79085"
  "0x4Fdd5551d20f0D3798fD9Da624Ae8FCC6959EDB2"
  "0x1d7C41eCc9D30f84a922708C9aEA53C3F5DBcB65"
  "0x3e1fD6000B547F1D8302D6eeB89aadeEA5F6dE3d"
  "0x4Ae924b2b7F4992b11285DAFE052D158Dfd80d06"
  "0x7d4B0dEDB4E8D43801823632e788cd600e45292C"
  "0x2F38a48F8968114aA5a62E3A106d2D3DD5478bF2"
  "0x2F53c488E589c1e023ccE9f21f1379213A7C30fa"
  "0xE38C099F0732eca09881F99E7431A619d3D033d9"
)

IFS=,
GUARDIAN_SET="([${GUARDIAN_ADDRESSES[*]}], $EXPIRATION_TIME)"

# Verifier Update
UPDATE_FUNCTION_SIG="update(bytes)"
PULL_MESSAGE=0x0200000001

anvil --quiet --host 0.0.0.0 &

deadline=$((SECONDS+60))
until cast block-number >/dev/null 2>&1; do
    if [ "$SECONDS" -ge "$deadline" ]; then
        echo "Timed out waiting for anvil" >&2
        exit 1
    fi
    sleep 0.5
done

forge create --private-key "$PRIVATE_KEY" --broadcast test/WormholeVerifier.t.sol:WormholeV1Mock
forge create WormholeVerifier --private-key "$PRIVATE_KEY" --broadcast --constructor-args $MOCK_ADDRESS 0 0 0 0x
cast send --private-key "$PRIVATE_KEY" "$MOCK_ADDRESS" "$APPEND_SET_FUNCTION_SIG" "$GUARDIAN_SET"
cast send --private-key "$PRIVATE_KEY" "$VERIFIER_ADDRESS" "$UPDATE_FUNCTION_SIG" "$PULL_MESSAGE"
fg
