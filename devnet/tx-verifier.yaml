apiVersion: batch/v1
kind: Job
metadata:
  name: tx-verifier-test
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: tx-verifier
        name: tx-verifier
    spec:
      restartPolicy: Never
      shareProcessNamespace: true
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        # This container monitors the logs generated by Transfer Verifier and signals whether the test was successful.
        # The readiness probe for the other containers relies on the file written by the command invoked here.
        - name: tx-verifier-monitor
          image: tx-verifier-monitor
          volumeMounts:
          - name: log-volume
            mountPath: /logs
          env:
            - name: ERROR_PATTERN
              # This error string comes from the Transfer Verifier package in node/pkg/txverifier
              value: "invalid receipt: no deposits and no transfers"
            - name: ERROR_LOG_PATH
              value: "/logs/error.log"
          command: ["/bin/sh", "-c"]
          args:
            - |
              # Run the monitoring script
              echo "staring to run the monitor script"
              /monitor.sh && touch /logs/success
          readinessProbe:
            exec:
              command:
                - test
                - -e
                - "/logs/success"
            initialDelaySeconds: 30
            periodSeconds: 5
        # This container runs the script that simulates malicious traffic. The Transfer Verifier should detect this.
        - name: tx-verifier-test
          image: tx-verifier-test
          volumeMounts:
           - name: log-volume
             mountPath: /logs
          command:
            - /bin/bash
            - -c
            - "/transfer-verifier-test.sh"
          env:
            - name: RPC_URL
              value: "ws://eth-devnet:8545"
          readinessProbe:
            exec:
              command:
                - test
                - -e
                - "/logs/success"
            initialDelaySeconds: 30
            periodSeconds: 5
        # This container runs the Transfer Verifier CLI tool, monitoring the Ethereum devnet set-up by Tilt.
        - name: tx-verifier
          image: guardiand-image
          volumeMounts:
           - name: log-volume
             mountPath: /logs
          command:
            ["/bin/sh", "-c"]
          # See `ethereum/.env.test` and related shell scripts for how these values are configured in localnet testing.
          args:
            - |
              exec /guardiand \
                           transfer-verifier \
                           evm \
                           --rpcUrl ws://eth-devnet:8545 \
                           --coreContract 0xC89Ce4735882C9F0f0FE26686c53074E09B0D550 \
                           --tokenContract 0x0290FB167208Af455bB137780163b7B7a9a10C16 \
                           --wrappedNativeContract 0xDDb64fE46a91D46ee29420539FC25FD07c5FEa3E \
                           --logLevel=info \
                           2> /logs/error.log \
          readinessProbe:
            exec:
              command:
                - test
                - -e
                - "/logs/success"
            initialDelaySeconds: 30
            periodSeconds: 5
      volumes:
      - name: log-volume
        emptyDir: {}