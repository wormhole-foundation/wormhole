FROM ghcr.io/wormholelabs-xyz/foundry:nightly-55bf41564f605cae3ca4c95ac5d468b1f14447f9@sha256:50ffe8f3ba79274eaab85ce65e769e3d66b1c680f5a9acb9c25a393c4daeeeeb as foundry
FROM node:19.6.1-slim@sha256:e684615bdfb71cb676b3d0dfcc538c416f7254697d8f9639bd87255062fd1681

COPY --from=foundry /usr/local/bin/forge /bin/forge

RUN apt-get update && apt-get -y install git python3 build-essential curl netcat vim

RUN mkdir -p /app
WORKDIR /app

COPY ethereum/package.json ethereum/package-lock.json ./ethereum/
RUN --mount=type=cache,uid=1000,gid=1000,target=/home/node/.npm \
  npm ci --prefix ethereum
COPY ethereum ./ethereum

COPY relayer/ethereum/package.json relayer/ethereum/package-lock.json ./relayer/ethereum/
RUN --mount=type=cache,uid=1000,gid=1000,target=/home/node/.npm \
  npm ci --prefix relayer/ethereum
COPY relayer/ethereum ./relayer/ethereum

COPY solana/idl ./solana/idl/

COPY sdk/js/package.json sdk/js/package-lock.json  ./sdk/js/
RUN --mount=type=cache,uid=1000,gid=1000,target=/home/node/.npm \
  npm ci --prefix sdk/js
COPY sdk/js ./sdk/js
RUN npm run build --prefix sdk/js

COPY testing ./testing

WORKDIR /app/testing
